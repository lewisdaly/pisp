<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1439px" preserveAspectRatio="none" style="width:1957px;height:1439px;" version="1.1" viewBox="0 0 1957 1439" width="1957px" zoomAndPan="magnify"><defs><filter height="300%" id="frchmw2lw56bc" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1427.627" style="stroke: #A80036; stroke-width: 1.0;" width="101" x="1" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="38" y="18.5684">PISP</text><rect fill="#DDDDDD" height="1427.627" style="stroke: #A80036; stroke-width: 1.0;" width="616" x="104" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="61" x="381.5" y="18.5684">Mojaloop</text><rect fill="#DDDDDD" height="1427.627" style="stroke: #A80036; stroke-width: 1.0;" width="805" x="1067" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="46" x="1446.5" y="18.5684">DFSP A</text><rect fill="#DDDDDD" height="1427.627" style="stroke: #A80036; stroke-width: 1.0;" width="75" x="1874" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="1889.5" y="18.5684">DFSP B</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="51" x2="51" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="160" x2="160" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="632" x2="632" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="694" x2="694" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1104" x2="1104" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1526" x2="1526" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1621" x2="1621" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1719" x2="1719" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1820" x2="1820" y1="77.2871" y2="1378.6504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1911" x2="1911" y1="77.2871" y2="1378.6504"/><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="5" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="12" y="62.334">PISP Server</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="5" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="12" y="1398.1855">PISP Server</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="108" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="115" y="62.334">auth-service</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="108" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="115" y="1398.1855">auth-service</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="601" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="608" y="62.334">Switch</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="58" x="601" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="608" y="1398.1855">Switch</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="673" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="680" y="62.334">ALS</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="673" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="680" y="1398.1855">ALS</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="1071" y="25.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1078" y="45.8457">DFSP A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1078.5" y="62.334">(Payer)</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="1071" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="1078" y="1398.1855">DFSP A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1078.5" y="1414.6738">(Payer)</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1486" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1493" y="62.334">3p-sa-in</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1486" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1493" y="1398.1855">3p-sa-in</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1576" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1583" y="62.334">3p-sa-out</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="1576" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1583" y="1398.1855">3p-sa-out</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="82" x="1676" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="1683" y="62.334">sdk-sa-in</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="82" x="1676" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="1683" y="1398.1855">sdk-sa-in</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1772" y="41.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1779" y="62.334">sdk-sa-out</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1772" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1779" y="1398.1855">sdk-sa-out</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1878" y="25.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1886.5" y="45.8457">DFSP B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1885" y="62.334">(Payee)</text><rect fill="#FEFECE" filter="url(#frchmw2lw56bc)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1878" y="1377.6504"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1886.5" y="1398.1855">DFSP B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1885" y="1414.6738">(Payee)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="0" x2="1950" y1="88.2871" y2="88.2871"/><rect fill="#EEEEEE" filter="url(#frchmw2lw56bc)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1950" x="0" y="109.9424"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1950" y1="109.9424" y2="109.9424"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1950" y1="112.9424" y2="112.9424"/><rect fill="#EEEEEE" filter="url(#frchmw2lw56bc)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="120" x="915" y="99.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="921" y="115.8555">Transfer Phase</text><rect fill="#FFFFFF" filter="url(#frchmw2lw56bc)" height="252" style="stroke: #A80036; stroke-width: 1.0;" width="284" x="962" y="137.5977"/><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="966" y="153.6646">POST /transfers</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="966" y="168.7974">FSPIOP-Source: dfspa</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="966" y="183.9302">FSPIOP-Destination: dfspb</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="966" y="199.5645">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="974" y="214.875">"transferId": "321",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="974" y="230.1855">"quoteId": "456",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="974" y="245.4961">"payerFsp": "dfspa",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="974" y="260.8066">"payeeFsp": "dfspb",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="974" y="276.1172">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="982" y="291.4277">"amount": "100",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="982" y="306.7383">"currency": "USD"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="974" y="322.0488">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="974" y="337.3594">"expiration": "2020-06-15T13:00:00.000",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="974" y="352.6699">"ilpPacket": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="974" y="367.9805">"condition": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="966" y="383.291">}</text><polygon fill="#A80036" points="643,412.166,633,416.166,643,420.166,639,416.166" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="1103" y1="416.166" y2="416.166"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="649" y="411.1001">POST /transfers</text><polygon fill="#A80036" points="1092,441.2988,1102,445.2988,1092,449.2988,1096,445.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="632" x2="1098" y1="445.2988" y2="445.2988"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="639" y="440.2329">202 Accepted</text><rect fill="#FFFFFF" filter="url(#frchmw2lw56bc)" height="252" style="stroke: #A80036; stroke-width: 1.0;" width="284" x="490" y="458.2988"/><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="494" y="474.3657">POST /transfers</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="494" y="489.4985">FSPIOP-Source: dfspa</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="494" y="504.6313">FSPIOP-Destination: dfspb</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="494" y="520.2656">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="502" y="535.5762">"transferId": "321",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="502" y="550.8867">"quoteId": "456",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="502" y="566.1973">"payerFsp": "dfspa",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="502" y="581.5078">"payeeFsp": "dfspb",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="502" y="596.8184">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="510" y="612.1289">"amount": "100",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="510" y="627.4395">"currency": "USD"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="502" y="642.75">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="502" y="658.0605">"expiration": "2020-06-15T13:00:00.000",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="502" y="673.3711">"ilpPacket": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="502" y="688.6816">"condition": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="494" y="703.9922">}</text><polygon fill="#A80036" points="1899.5,732.8672,1909.5,736.8672,1899.5,740.8672,1903.5,736.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="632" x2="1905.5" y1="736.8672" y2="736.8672"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="639" y="731.8013">POST /transfers</text><polygon fill="#A80036" points="643,762,633,766,643,770,639,766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="637" x2="1910.5" y1="766" y2="766"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="649" y="760.9341">202 Accepted</text><rect fill="#FFFFFF" filter="url(#frchmw2lw56bc)" height="129" style="stroke: #A80036; stroke-width: 1.0;" width="356" x="1550" y="779"/><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="1554" y="795.0669">PUT /transfers/321</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="1554" y="810.1997">FSPIOP-Source: dfspb</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="1554" y="825.3325">FSPIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1554" y="840.9668">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="1562" y="856.2773">"fulfilment": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1562" y="871.5879">"completedTimestamp": "2020-06-15T12:01:00.000",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="1562" y="886.8984">"transferState": "COMMITTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1554" y="902.209">}</text><polygon fill="#A80036" points="643,931.084,633,935.084,643,939.084,639,935.084" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="1910.5" y1="935.084" y2="935.084"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="649" y="930.0181">PUT /transfers/321</text><polygon fill="#A80036" points="1899.5,960.2168,1909.5,964.2168,1899.5,968.2168,1903.5,964.2168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="632" x2="1905.5" y1="964.2168" y2="964.2168"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="639" y="959.1509">200 OK</text><rect fill="#FFFFFF" filter="url(#frchmw2lw56bc)" height="129" style="stroke: #A80036; stroke-width: 1.0;" width="356" x="454" y="977.2168"/><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="458" y="993.2837">PUT /transfers/321</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="458" y="1008.4165">FSPIOP-Source: dfspb</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="458" y="1023.5493">FSPIOP-Destination: dfspa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="458" y="1039.1836">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="466" y="1054.4941">"fulfilment": "...",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="466" y="1069.8047">"completedTimestamp": "2020-06-15T12:01:00.000",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="466" y="1085.1152">"transferState": "COMMITTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="458" y="1100.4258">}</text><polygon fill="#A80036" points="1092,1129.3008,1102,1133.3008,1092,1137.3008,1096,1133.3008" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="632" x2="1098" y1="1133.3008" y2="1133.3008"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="639" y="1128.2349">PUT /transfers/321</text><polygon fill="#A80036" points="643,1158.4336,633,1162.4336,643,1166.4336,639,1162.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="637" x2="1103" y1="1162.4336" y2="1162.4336"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="649" y="1157.3677">200 OK</text><rect fill="#FFFFFF" filter="url(#frchmw2lw56bc)" height="129" style="stroke: #A80036; stroke-width: 1.0;" width="344" x="460" y="1175.4336"/><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="336" x="464" y="1191.5005">PATCH /thirdpartyRequests/transactions/123</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="464" y="1206.6333">FSPIOP-Source: switch</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="464" y="1221.7661">FSPIOP-Destination: pispa</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="464" y="1237.4004">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="472" y="1252.7109">"transactionId": "987",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="472" y="1268.0215">"transactionRequestState": "ACCEPTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="472" y="1283.332">"transactionState": "COMMITTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="464" y="1298.6426">}</text><polygon fill="#A80036" points="62.5,1327.5176,52.5,1331.5176,62.5,1335.5176,58.5,1331.5176" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="56.5" x2="631" y1="1331.5176" y2="1331.5176"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="68.5" y="1326.4517">PATCH /thirdpartyRequests/transactions/123</text><polygon fill="#A80036" points="620,1356.6504,630,1360.6504,620,1364.6504,624,1360.6504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="51.5" x2="626" y1="1360.6504" y2="1360.6504"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="58.5" y="1355.5845">200 OK</text><!--MD5=[e6602a07423f185030b066b57957b1a0]
@startuml

title PISPTransferDetailedAPI

!include participants_api.iuml

== Discovery (Lookup) ==
rnote right of D1 #Light
**""GET /parties/MSISDN/+4412345678""**
""FSPIOP-Source: pispa""
end note
D1 -> S: ""GET /parties/MSISDN/+4412345678""
S - -> D1: ""202 Accepted""

... ALS lookup flow not shown here ...

rnote over S #Light
**""GET /parties/MSISDN/+4412345678""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspb""
end note
S -> D3: ""GET /parties/MSISDN/+4412345678""
D3 - -> S: ""202 Accepted""

rnote left of D3 #Light
**""PUT /parties/MSISDN/+4412345678""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: pispa""
{
  partyIdType: "MSISDN",
  partyIdentifier: "+4412345678",
  party: {
    partyIdInfo: {
      partyIdType: "MSISDN",
      partyIdentifier: "+4412345678",
      fspId: 'dfspb",
    },
    name: "Bhavesh S.",
    accounts: [
      {
        "address": "dfspb.8f027046-b82a-4fa9-838b-70210fcf8137",
        "currency": "USD"
      }
    ]
  }
}
end note
D3 -> S: ""PUT /parties/MSISDN/+4412345678""
S - -> D3: ""200 OK""

rnote over S #Light
**""PUT /parties/MSISDN/+4412345678""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: pispa""
{
  partyIdType: "MSISDN",
  partyIdentifier: "+4412345678",
  party: {
    partyIdInfo: {
      partyIdType: "MSISDN",
      partyIdentifier: "+4412345678",
      fspId: 'dfspb",
    },
    name: "Bhavesh S.",
    accounts: [
      {
        "address": "dfspb.8f027046-b82a-4fa9-838b-70210fcf8137",
        "currency": "USD"
      }
    ]
  }
}
end note
S -> D1: ""PUT /parties/MSISDN/+4412345678""
D1 - -> S: ""200 OK""

... PISP confirms payee party with their user ...

newpage

== Agreement Phase ==
rnote right of D1 #Light
**""POST /thirdpartyRequests/transactions""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "transactionRequestId": "123",
  //This tells dfspa which account to deduct funds from
  //it's an opaque identifier that the DFSP knows about
  **"sourceAccountId": "dfspa.1111-2222",**
  //This tells dfspa and auth-service which consent allows the pisp to initiate this tx
  **"consentId": "111"**
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    }
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "expiration": "2020-06-15T22:17:28.985-01:00"
}
end note
D1 -> S: ""POST /thirdpartyRequests/transactions""
S - -> D1: ""202 Accepted""

rnote over S #Light
**""POST /thirdpartyRequests/transactions""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "transactionRequestId": "123",
  //This tells dfspa which account to deduct funds from
  //it's an opaque identifier that the DFSP knows about
  **"sourceAccountId": "dfspa.1111-2222",**
  //This tells dfspa and auth-service which consent allows the pisp to initiate this tx
  **"consentId": "111"**
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "expiration": "2020-06-15T00:00:00.000"
}
end note
S -> D2: ""POST /thirdpartyRequests/transactions""
D2 - -> S: ""202 Accepted""
D2 -> D2: Lookup this ""consentId"", ""sourceAccountId"" \nand ""pispId"". Verify that they exist, and consent \nis granted with a valid credential
D2 -> D2: Generate a unique transactionId for this transaction request: ""987""


rnote left of D2 #Light
**""PUT /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "RECEIVED"
}
end note
D2 -> S: ""PUT /thirdpartyRequests/transactions/123""
S - -> D2: ""200 OK""

rnote over S #Light
**""PUT /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "RECEIVED"
}
end note
S -> D1: ""PUT /thirdpartyRequests/transactions/123""
D1 - -> S: ""200 OK""



rnote left of D2 #Light
**""POST /quotes""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "quoteId": "456", //Set by the payer dfsp
  "transactionId": "987", //Set by the payer dfsp
  *"transactionRequestId": "123", //Relates to the original thirdpartyRequest!*
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "quote note"
}
end note
D2 -> S: ""POST /quotes""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /quotes""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "quoteId": "456", //Set by the payer dfsp
  "transactionId": "987", //Set by the payer dfsp
  *"transactionRequestId": "123", //Relates to the original thirdpartyRequest!*
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "quote note"
}
end note
S -> D3: ""POST /quotes""
D3 - -> S: ""202 Accepted""

rnote left of D2 #Light
**""PUT /quotes/456""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "transferAmount": {
    "amount": "100",
    "currency": "USD"
  },
  "payeeReceiveAmount": {
    "amount": "99",
    "currency": "USD"
  },
  "payeeFspFee": {
    "amount": "1",
    "currency": "USD"
  },
  "expiration": "2020-06-15T12:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
D3 -> S: ""PUT /quotes/456""
S - -> D3: ""200 OK""

rnote left of D2 #Light
**""PUT /quotes/456""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "transferAmount": {
    "amount": "100",
    "currency": "USD"
  },
  "payeeReceiveAmount": {
    "amount": "99",
    "currency": "USD"
  },
  "payeeFspFee": {
    "amount": "1",
    "currency": "USD"
  },
  "expiration": "2020-06-15T12:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
S -> D2: ""PUT /quotes/456""
D2 - -> S: ""200 OK""

note left of D2
  DFSPA has the quote, they can now ask
  the PISP for authorization
end note

rnote left of D2 #Light
**""POST /authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  //transactionRequestId is our 'primary key'
  //to refer to this authorization
  **"transactionRequestId": "123",**
  "authenticationType": "U2F",
  "retriesLeft": "1",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionId": "987",
  "quote": {
    //TODO: do we need quoteId here?
    "transferAmount": {
      "amount": "100",
      "currency": "USD"
    },
    "payeeReceiveAmount": {
      "amount": "99",
      "currency": "USD"
    },
    "payeeFspFee": {
      "amount": "1",
      "currency": "USD"
    },
    "expiration": "2020-06-15T12:00:00.000",
    "ilpPacket": "...",
    "condition": "...",
  }
}
end note
D2 -> S: ""POST /authorizations""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  //transactionRequestId is our 'primary key'
  //to refer to this authorization
  **"transactionRequestId": "123",**
  "authenticationType": "U2F",
  "retriesLeft": "1",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionId": "987",
  "quote": {
    "transferAmount": {
      "amount": "100",
      "currency": "USD"
    },
    "payeeReceiveAmount": {
      "amount": "99",
      "currency": "USD"
    },
    "payeeFspFee": {
      "amount": "1",
      "currency": "USD"
    },
    "expiration": "2020-06-15T12:00:00.000",
    "ilpPacket": "...",
    "condition": "...",
  }
}
end note
S -> D1: ""POST /authorizations""
D1 - -> S: ""202 Accepted""

note right of D1
  PISP checks the quote with the user,
  and uses FIDO to sign the the QuoteResponse object
end note

rnote right of D1 #Light
**""PUT /authorizations/123""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "authenticationInfo": {
    "authentication": "U2F",
    "authenticationValue": {
      "pinValue": "<base64 encoded binary - the signed QuoteResponse>",
      "counter": "1"
    }
  }
  "responseType": "ENTERED"
}
end note
D1 -> S: ""PUT /authorizations/123""

S - -> D1: ""200 OK""


rnote over S #Light
**""PUT /authorizations/123""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "authenticationInfo": {
    "authentication": "U2F",
    "authenticationValue": {
      "pinValue": "<base64 encoded binary - the signed QuoteResponse>",
      "counter": "1"
    }
  }
  "responseType": "ENTERED"
}
end note
S -> D2: ""PUT /authorizations/123""
D2 - -> S: ""200 OK""


D2 -> D2: Lookup the ""thirdpartyRequests/transaction""\nrequest, get the ""consentId"" and ""sourceAccountId""
D2 -> D2: Confirm pispId from ""PUT /authorizations/123""\n matches the ""thirdpartyRequests/transaction""

note over D2
  Switch has the signed condition
  For 3rd party FIDO, it now needs to make sure everything checks out
end note

rnote left of D2 #Light
**""POST /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: central-auth""
{
  //from ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from ""PUT /authorizations/123"" callback: .authenticationInfo.authenticationValue.pinValue
  "value": "<base64 encoded binary - the signed quote response object>",

  //from ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
}
end note
D2 -> S: ""POST /thirdpartyRequests/transactions/123/authorizations""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: central-auth""
{
  //from ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from ""PUT /authorizations/123"" callback: .authenticationInfo.authenticationValue.pinValue
  "value": "<base64 encoded binary - the signed quote response object>",

  //from ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222",

  "status": "PENDING"
}
end note
S -> AUTHS: ""POST /thirdpartyRequests/transactions/123/authorizations""
AUTHS - -> S: ""202 Accepted""

AUTHS -> AUTHS: Lookup this consent based on consentId
AUTHS -> AUTHS: Ensure the sourceAccountId matches what is in Consent
AUTHS -> AUTHS: Check that the signed bytes match the \npublickey we have stored for the consent

rnote right of AUTHS #Light
**""PUT /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: central-auth""
""FSPIOP-Destination: dfspa""
{
  //from the ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from the ""PUT /authorizations/123"" callback
  "value": "<base64 encoded binary - the signed quote response object>",

  //from the ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from the ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
  "status": "VERIFIED"
}
end note
AUTHS -> S: ""PUT /thirdpartyRequests/transactions/123/authorizations""
S - -> AUTHS: ""200 OK""

rnote over S #Light
**""PUT /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: central-auth""
""FSPIOP-Destination: dfspa""
{
  //from the ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from the ""PUT /authorizations/123"" callback
  "value": "<base64 encoded binary - the signed quote response object>",

  //from the ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from the ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
  "status": "VERIFIED"
}
end note
S -> D2: ""PUT /thirdpartyRequests/transactions/123/authorizations""
D2 - -> S: ""200 OK""

note over D2
  DFSPA now knows that the user signed this transaction
  and can go ahead and initiate the transfer
end note

newpage

== Transfer Phase ==

rnote over D2 #Light
**""POST /transfers""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "transferId": "321",
  "quoteId": "456",
  "payerFsp": "dfspa",
  "payeeFsp": "dfspb",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "expiration": "2020-06-15T13:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
D2 -> S: ""POST /transfers""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /transfers""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "transferId": "321",
  "quoteId": "456",
  "payerFsp": "dfspa",
  "payeeFsp": "dfspb",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "expiration": "2020-06-15T13:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
S -> D3: ""POST /transfers""
D3 - -> S: ""202 Accepted""

rnote left of D3 #Light
**""PUT /transfers/321""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "fulfilment": "...",
  "completedTimestamp": "2020-06-15T12:01:00.000",
  "transferState": "COMMITTED"
}
end note
D3 -> S: ""PUT /transfers/321""
S - -> D3: ""200 OK""

rnote over S #Light
**""PUT /transfers/321""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "fulfilment": "...",
  "completedTimestamp": "2020-06-15T12:01:00.000",
  "transferState": "COMMITTED"
}
end note
S -> D2: ""PUT /transfers/321""
D2 - -> S: ""200 OK""


rnote over S #Light
**""PATCH /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: switch""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "ACCEPTED",
  "transactionState": "COMMITTED"
}
end note
S -> D1: ""PATCH /thirdpartyRequests/transactions/123""
D1 - -> S: ""200 OK""


@enduml

@startuml

title PISPTransferDetailedAPI

box "PISP"
participant "PISP Server" as D1
end box
box "Mojaloop"
    participant "auth-service" as AUTHS
    participant Switch as S
    participant "ALS" as A
end box
box "DFSP A"
    participant "DFSP A\n(Payer)" as D2
    participant "3p-sa-in" as D2_3psa_in
    participant "3p-sa-out" as D2_3psa_out
    participant "sdk-sa-in" as D2_sdksa_in
    participant "sdk-sa-out" as D2_sdksa_out
end box
box "DFSP B"
    participant "DFSP B\n(Payee)" as D3
end box

== Discovery (Lookup) ==
rnote right of D1 #Light
**""GET /parties/MSISDN/+4412345678""**
""FSPIOP-Source: pispa""
end note
D1 -> S: ""GET /parties/MSISDN/+4412345678""
S - -> D1: ""202 Accepted""

... ALS lookup flow not shown here ...

rnote over S #Light
**""GET /parties/MSISDN/+4412345678""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspb""
end note
S -> D3: ""GET /parties/MSISDN/+4412345678""
D3 - -> S: ""202 Accepted""

rnote left of D3 #Light
**""PUT /parties/MSISDN/+4412345678""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: pispa""
{
  partyIdType: "MSISDN",
  partyIdentifier: "+4412345678",
  party: {
    partyIdInfo: {
      partyIdType: "MSISDN",
      partyIdentifier: "+4412345678",
      fspId: 'dfspb",
    },
    name: "Bhavesh S.",
    accounts: [
      {
        "address": "dfspb.8f027046-b82a-4fa9-838b-70210fcf8137",
        "currency": "USD"
      }
    ]
  }
}
end note
D3 -> S: ""PUT /parties/MSISDN/+4412345678""
S - -> D3: ""200 OK""

rnote over S #Light
**""PUT /parties/MSISDN/+4412345678""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: pispa""
{
  partyIdType: "MSISDN",
  partyIdentifier: "+4412345678",
  party: {
    partyIdInfo: {
      partyIdType: "MSISDN",
      partyIdentifier: "+4412345678",
      fspId: 'dfspb",
    },
    name: "Bhavesh S.",
    accounts: [
      {
        "address": "dfspb.8f027046-b82a-4fa9-838b-70210fcf8137",
        "currency": "USD"
      }
    ]
  }
}
end note
S -> D1: ""PUT /parties/MSISDN/+4412345678""
D1 - -> S: ""200 OK""

... PISP confirms payee party with their user ...

newpage

== Agreement Phase ==
rnote right of D1 #Light
**""POST /thirdpartyRequests/transactions""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "transactionRequestId": "123",
  //This tells dfspa which account to deduct funds from
  //it's an opaque identifier that the DFSP knows about
  **"sourceAccountId": "dfspa.1111-2222",**
  //This tells dfspa and auth-service which consent allows the pisp to initiate this tx
  **"consentId": "111"**
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    }
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "expiration": "2020-06-15T22:17:28.985-01:00"
}
end note
D1 -> S: ""POST /thirdpartyRequests/transactions""
S - -> D1: ""202 Accepted""

rnote over S #Light
**""POST /thirdpartyRequests/transactions""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "transactionRequestId": "123",
  //This tells dfspa which account to deduct funds from
  //it's an opaque identifier that the DFSP knows about
  **"sourceAccountId": "dfspa.1111-2222",**
  //This tells dfspa and auth-service which consent allows the pisp to initiate this tx
  **"consentId": "111"**
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "expiration": "2020-06-15T00:00:00.000"
}
end note
S -> D2: ""POST /thirdpartyRequests/transactions""
D2 - -> S: ""202 Accepted""
D2 -> D2: Lookup this ""consentId"", ""sourceAccountId"" \nand ""pispId"". Verify that they exist, and consent \nis granted with a valid credential
D2 -> D2: Generate a unique transactionId for this transaction request: ""987""


rnote left of D2 #Light
**""PUT /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "RECEIVED"
}
end note
D2 -> S: ""PUT /thirdpartyRequests/transactions/123""
S - -> D2: ""200 OK""

rnote over S #Light
**""PUT /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "RECEIVED"
}
end note
S -> D1: ""PUT /thirdpartyRequests/transactions/123""
D1 - -> S: ""200 OK""



rnote left of D2 #Light
**""POST /quotes""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "quoteId": "456", //Set by the payer dfsp
  "transactionId": "987", //Set by the payer dfsp
  *"transactionRequestId": "123", //Relates to the original thirdpartyRequest!*
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "quote note"
}
end note
D2 -> S: ""POST /quotes""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /quotes""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "quoteId": "456", //Set by the payer dfsp
  "transactionId": "987", //Set by the payer dfsp
  *"transactionRequestId": "123", //Relates to the original thirdpartyRequest!*
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+4412345678",
      "fspId": "dfspb"
    }
  },
  "payer": {
    "personalInfo": {
      "complexName": {
        "firstName": "Ayesha",
        "lastName": "Takia"
      }
    },
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "+44 8765 4321",
      "fspId": "dfspa"
    },
  },
  "amountType": "SEND",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "quote note"
}
end note
S -> D3: ""POST /quotes""
D3 - -> S: ""202 Accepted""

rnote left of D2 #Light
**""PUT /quotes/456""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "transferAmount": {
    "amount": "100",
    "currency": "USD"
  },
  "payeeReceiveAmount": {
    "amount": "99",
    "currency": "USD"
  },
  "payeeFspFee": {
    "amount": "1",
    "currency": "USD"
  },
  "expiration": "2020-06-15T12:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
D3 -> S: ""PUT /quotes/456""
S - -> D3: ""200 OK""

rnote left of D2 #Light
**""PUT /quotes/456""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "transferAmount": {
    "amount": "100",
    "currency": "USD"
  },
  "payeeReceiveAmount": {
    "amount": "99",
    "currency": "USD"
  },
  "payeeFspFee": {
    "amount": "1",
    "currency": "USD"
  },
  "expiration": "2020-06-15T12:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
S -> D2: ""PUT /quotes/456""
D2 - -> S: ""200 OK""

note left of D2
  DFSPA has the quote, they can now ask
  the PISP for authorization
end note

rnote left of D2 #Light
**""POST /authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  //transactionRequestId is our 'primary key'
  //to refer to this authorization
  **"transactionRequestId": "123",**
  "authenticationType": "U2F",
  "retriesLeft": "1",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionId": "987",
  "quote": {
    //TODO: do we need quoteId here?
    "transferAmount": {
      "amount": "100",
      "currency": "USD"
    },
    "payeeReceiveAmount": {
      "amount": "99",
      "currency": "USD"
    },
    "payeeFspFee": {
      "amount": "1",
      "currency": "USD"
    },
    "expiration": "2020-06-15T12:00:00.000",
    "ilpPacket": "...",
    "condition": "...",
  }
}
end note
D2 -> S: ""POST /authorizations""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: pispa""
{
  //transactionRequestId is our 'primary key'
  //to refer to this authorization
  **"transactionRequestId": "123",**
  "authenticationType": "U2F",
  "retriesLeft": "1",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "transactionId": "987",
  "quote": {
    "transferAmount": {
      "amount": "100",
      "currency": "USD"
    },
    "payeeReceiveAmount": {
      "amount": "99",
      "currency": "USD"
    },
    "payeeFspFee": {
      "amount": "1",
      "currency": "USD"
    },
    "expiration": "2020-06-15T12:00:00.000",
    "ilpPacket": "...",
    "condition": "...",
  }
}
end note
S -> D1: ""POST /authorizations""
D1 - -> S: ""202 Accepted""

note right of D1
  PISP checks the quote with the user,
  and uses FIDO to sign the the QuoteResponse object
end note

rnote right of D1 #Light
**""PUT /authorizations/123""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "authenticationInfo": {
    "authentication": "U2F",
    "authenticationValue": {
      "pinValue": "<base64 encoded binary - the signed QuoteResponse>",
      "counter": "1"
    }
  }
  "responseType": "ENTERED"
}
end note
D1 -> S: ""PUT /authorizations/123""

S - -> D1: ""200 OK""


rnote over S #Light
**""PUT /authorizations/123""**
""FSPIOP-Source: pispa""
""FSPIOP-Destination: dfspa""
{
  "authenticationInfo": {
    "authentication": "U2F",
    "authenticationValue": {
      "pinValue": "<base64 encoded binary - the signed QuoteResponse>",
      "counter": "1"
    }
  }
  "responseType": "ENTERED"
}
end note
S -> D2: ""PUT /authorizations/123""
D2 - -> S: ""200 OK""


D2 -> D2: Lookup the ""thirdpartyRequests/transaction""\nrequest, get the ""consentId"" and ""sourceAccountId""
D2 -> D2: Confirm pispId from ""PUT /authorizations/123""\n matches the ""thirdpartyRequests/transaction""

note over D2
  Switch has the signed condition
  For 3rd party FIDO, it now needs to make sure everything checks out
end note

rnote left of D2 #Light
**""POST /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: central-auth""
{
  //from ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from ""PUT /authorizations/123"" callback: .authenticationInfo.authenticationValue.pinValue
  "value": "<base64 encoded binary - the signed quote response object>",

  //from ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
}
end note
D2 -> S: ""POST /thirdpartyRequests/transactions/123/authorizations""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: central-auth""
{
  //from ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from ""PUT /authorizations/123"" callback: .authenticationInfo.authenticationValue.pinValue
  "value": "<base64 encoded binary - the signed quote response object>",

  //from ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222",

  "status": "PENDING"
}
end note
S -> AUTHS: ""POST /thirdpartyRequests/transactions/123/authorizations""
AUTHS - -> S: ""202 Accepted""

AUTHS -> AUTHS: Lookup this consent based on consentId
AUTHS -> AUTHS: Ensure the sourceAccountId matches what is in Consent
AUTHS -> AUTHS: Check that the signed bytes match the \npublickey we have stored for the consent

rnote right of AUTHS #Light
**""PUT /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: central-auth""
""FSPIOP-Destination: dfspa""
{
  //from the ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from the ""PUT /authorizations/123"" callback
  "value": "<base64 encoded binary - the signed quote response object>",

  //from the ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from the ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
  "status": "VERIFIED"
}
end note
AUTHS -> S: ""PUT /thirdpartyRequests/transactions/123/authorizations""
S - -> AUTHS: ""200 OK""

rnote over S #Light
**""PUT /thirdpartyRequests/transactions/123/authorizations""**
""FSPIOP-Source: central-auth""
""FSPIOP-Destination: dfspa""
{
  //from the ""PUT /quotes/456"" callback
  "challenge": "<QuoteResponse object>",

  //from the ""PUT /authorizations/123"" callback
  "value": "<base64 encoded binary - the signed quote response object>",

  //from the ""thirdpartyRequests/transactions"" body
  "consentId": "111",

  //from the ""thirdpartyRequests/transactions"" body
  "sourceAccountId": "dfspa.1111-2222"
  "status": "VERIFIED"
}
end note
S -> D2: ""PUT /thirdpartyRequests/transactions/123/authorizations""
D2 - -> S: ""200 OK""

note over D2
  DFSPA now knows that the user signed this transaction
  and can go ahead and initiate the transfer
end note

newpage

== Transfer Phase ==

rnote over D2 #Light
**""POST /transfers""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "transferId": "321",
  "quoteId": "456",
  "payerFsp": "dfspa",
  "payeeFsp": "dfspb",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "expiration": "2020-06-15T13:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
D2 -> S: ""POST /transfers""
S - -> D2: ""202 Accepted""

rnote over S #Light
**""POST /transfers""**
""FSPIOP-Source: dfspa""
""FSPIOP-Destination: dfspb""
{
  "transferId": "321",
  "quoteId": "456",
  "payerFsp": "dfspa",
  "payeeFsp": "dfspb",
  "amount": {
    "amount": "100",
    "currency": "USD"
  },
  "expiration": "2020-06-15T13:00:00.000",
  "ilpPacket": "...",
  "condition": "...",
}
end note
S -> D3: ""POST /transfers""
D3 - -> S: ""202 Accepted""

rnote left of D3 #Light
**""PUT /transfers/321""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "fulfilment": "...",
  "completedTimestamp": "2020-06-15T12:01:00.000",
  "transferState": "COMMITTED"
}
end note
D3 -> S: ""PUT /transfers/321""
S - -> D3: ""200 OK""

rnote over S #Light
**""PUT /transfers/321""**
""FSPIOP-Source: dfspb""
""FSPIOP-Destination: dfspa""
{
  "fulfilment": "...",
  "completedTimestamp": "2020-06-15T12:01:00.000",
  "transferState": "COMMITTED"
}
end note
S -> D2: ""PUT /transfers/321""
D2 - -> S: ""200 OK""


rnote over S #Light
**""PATCH /thirdpartyRequests/transactions/123""**
""FSPIOP-Source: switch""
""FSPIOP-Destination: pispa""
{
  "transactionId": "987",
  "transactionRequestState": "ACCEPTED",
  "transactionState": "COMMITTED"
}
end note
S -> D1: ""PATCH /thirdpartyRequests/transactions/123""
D1 - -> S: ""200 OK""


@enduml

PlantUML version 1.2020.18(Thu Oct 01 03:40:44 PHT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>